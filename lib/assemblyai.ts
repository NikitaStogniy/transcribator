import { AssemblyAI, TranscribeParams } from "assemblyai";

// Инициализация клиента AssemblyAI
export function createAssemblyClient() {
  const assemblyApiKey = process.env.ASSEMBLYAI_API_KEY;
  if (!assemblyApiKey) {
    throw new Error("API ключ AssemblyAI не настроен");
  }

  return new AssemblyAI({
    apiKey: assemblyApiKey,
  });
}

// Загрузка файла в AssemblyAI
export async function uploadAudioFile(client: AssemblyAI, audioBuffer: Buffer) {
  return await client.files.upload(audioBuffer);
}

// Создание транскрипции
export async function createTranscription(
  client: AssemblyAI,
  uploadResponse: string,
  userConfig: Partial<TranscribeParams> = {}
) {
  // Значения по умолчанию для конфигурации транскрипции
  const defaultConfig: Partial<TranscribeParams> = {
    language_code: "ru",
    speaker_labels: true,
    sentiment_analysis: false,
    iab_categories: false,
    entity_detection: false,
    speech_model: "best",
    auto_highlights: false,
    speakers_expected: 4,
  };

  // Объединяем настройки по умолчанию и пользовательские данные
  const config: TranscribeParams = {
    ...defaultConfig,
    ...userConfig,
    audio: uploadResponse,
  } as TranscribeParams;

  return await client.transcripts.transcribe(config);
}

// Получение статуса транскрипции
export async function getTranscriptionStatus(
  client: AssemblyAI,
  transcriptId: string
) {
  return await client.transcripts.get(transcriptId);
}

// Запрос к LeMUR
export async function queryLeMur(
  client: AssemblyAI,
  transcriptId: string,
  prompt: string
) {
  const { response } = await client.lemur.task({
    transcript_ids: [transcriptId],
    prompt: prompt,
    final_model: "anthropic/claude-3-5-sonnet",
  });
  return response;
}

// Создание резюме с помощью LeMUR
export async function createSummaries(
  client: AssemblyAI,
  transcriptId: string
) {
  const templates = [
    {
      key: "summary_template1",
      prompt: `На основании предоставленной транскрибации аудио совещания по персонам сформируй итоговый протокол в следующем формате:
-  В начале протокола выведи заголовок "***Ключевые моменты ***".
-  Укажи дату и время совещания. Если они отсутствуют в транскрипции, используй значения "[ДАТА СОВЕЩАНИЯ НЕ УКАЗАНА]" и "[ВРЕМЯ СОВЕЩАНИЯ НЕ УКАЗАНО]".
-  Перечисли все ключевые моменты обсуждения, используя краткие пункты с маркерами (тире "-" или "•"). Каждый пункт должен содержать основные тезисы обсуждаемых вопросов, например, уточнение деталей по контракту, обмен информацией по проектам с партнерами, а также обсуждение этапов и сроков выполнения работ.
-  После списка ключевых моментов добавь раздел с заголовком "Задачи:" и перечисли все выявленные задачи, используя нумерованный список. Для каждой задачи задай параметры:
  • Описание задачи
  • Исполнителя (если не указан, выведи "не указан")
  • Срок выполнения (если не указан, выведи "не указан" или конкретное условное значение, как приведено в примере)
-  В конце протокола добавь примечание о том, что для полноты информации требуются дополнительные уточнения (например, дата совещания, имена участников и прочее), если они отсутствуют в исходной транскрибации.

Формат итогового ответа должен быть идентичен следующему примеру:

***Ключевые моменты ***
Дата: [ДАТА СОВЕЩАНИЯ НЕ УКАЗАНА]
Время: [ВРЕМЯ СОВЕЩАНИЯ НЕ УКАЗАНО]
-  Обсуждение контракта с техноконцерном. Уточнение подробностей документов, необходимость проверки двух экземпляров договора и сравнение их с нашим вариантом, проверка шифров разделов по ГОСТу 21.
-  Передача счета техноконцерту и ожидание оплаты.
-  Обсуждение проектов с белорусскими партнерами и проблема с получением ответа от Перетертого по ТЗ.
-  Проверка документации по проекту КВР и внесение изменений в ТЗ с участием Меншикова.
-  Планирование дальнейших действий по работе с белорусами и обсуждение времени для регистрации договора и его оплаты.
-  Решение задач по КБМ, сжатые сроки и необходимость актов выполненных работ. Обсуждение обследования объектов и пересчет стоимости работ.
-  Подготовка к совещанию по поводу китайского оборудования ВИЛА и пересчета стоимости с учетом выбора поставщиков.
-  Обсуждение необходимости идти на риск или не рисковать с партнерами по проекту, анализ альтернативных возможностей.
-  Вопрос ограничения коммуникации только с определенными лицами в отношении техноконцепции, проблемы в общении с Юрой.
-  Подготовка информации к совещанию по СМР, донесение данных о сорванных сроках.
-  Вопрос по Петропавловску и ответы от контактного лица через WhatsApp.
-  Обсуждение ситуации с труднонаходимым оборудованием и решение проблемы с датчиком Астера и его аналогами.
-  Подведение итогов по обсуждению контрактов, основных тем и задач, а также планирование следующих шагов.
[ПРИМЕЧАНИЕ: Фактическая дата, имена лиц и другая конкретная информация в протоколе отсутствуют, так как приведен текст выше не содержит этих данных. Для полноты протокола требуются дополнительные уточнения.]

Задачи:

1. Подготовить презентацию по каждому сотруднику для будущих совещаний.
   Исполнитель: не указан
   Срок: к следующему совещанию

2. Обсудить с Перетертым все моменты по проекту с белорусами и уточнить сроки.
   Исполнитель: Татьяна Владимировна
   Срок: не указан

3. Отработать все с компьютером, в частности синие и зеленые цвета.
   Исполнитель: Паша
   Срок: как можно скорее

4. Проверить ТЗ в контексте соответствия шифров разделов ГОСТу 21.
   Исполнитель: Кабанова
   Срок: как можно скорее

5. Настроить связь с Перетертым и узнать статус ответов по проекту с белорусами.
   Исполнитель: Татьяна Владимировна
   Срок: не указан

6. Отправить информацию Перетертым для согласования и подписания договора с Меншиковым.
   Исполнитель: Паша
   Срок: до 18 числа текущего месяца

7. Подготовить письмо для КБМ с уточнением сроков каждого этапа контракта и обсудить необходимость обследования.
   Исполнитель: Юль
   Срок: как можно скорее

8. Разобраться с датчиком Астера и возможностью его исключения из плана, обсудить с заказчиком.
   Исполнитель: Галкин, Паша
   Срок: как можно скорее

9. Получить и проанализировать новое КПП от Дениса.
   Исполнитель: Татьяна Владимировна
   Срок: не указан

10. Составить дорожную карту по объекту Ковчег и обсудить ее.
    Исполнитель: Виталий
    Срок: к 15:00 текущего дня

11. Собрать комиссии для оценки работ и получить информацию по пожарным инструментам.
    Исполнитель: не указан
    Срок: до следующего совещания

12. Составить предложение по маленькому котлу и двойному для заказчика.
    Исполнитель: не указан
    Срок: на следующий день после совещания

    Используй форматирование MD`,
    },
  ];

  const results: Record<string, string> = {};
  const errors: Record<string, string> = {};

  for (const template of templates) {
    try {
      const response = await queryLeMur(client, transcriptId, template.prompt);
      results[template.key] = response;
    } catch (error: unknown) {
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      errors[
        `${template.key}Error`
      ] = `Не удалось создать резюме для данного шаблона: ${errorMessage}`;
    }
  }

  return { results, errors };
}
